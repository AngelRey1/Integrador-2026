<nb-layout>
  <nb-layout-column class="no-layout-padding">
    <div class="reserva-page-container">
      
      <!-- Mensaje de feedback flotante -->
      <div class="feedback-message" *ngIf="mostrarFeedback">
        <nb-icon icon="alert-circle-outline"></nb-icon>
        <span>{{ mensajeFeedback }}</span>
      </div>

      <!-- Estado de carga -->
      <div class="reserva-card" *ngIf="cargandoEntrenador">
        <div class="loading-state">
          <nb-spinner status="primary" size="large"></nb-spinner>
          <p>Cargando información del entrenador...</p>
        </div>
      </div>

  <!-- Entrenador no encontrado -->
  <div class="reserva-card" *ngIf="!cargandoEntrenador && !entrenador">
    <div class="error-state">
      <nb-icon icon="alert-circle-outline" style="font-size: 3rem; color: #ff3d71;"></nb-icon>
      <h3>Entrenador no encontrado</h3>
      <p>El entrenador que buscas no existe o no está disponible.</p>
      <button nbButton status="primary" (click)="router.navigate(['/entrenadores'])">
        Ver otros entrenadores
      </button>
    </div>
  </div>

  <div class="reserva-card" *ngIf="!cargandoEntrenador && entrenador">
    <!-- Header con botón cerrar -->
    <div class="header-wrapper">
      <div>
        <h2 class="titulo-modal">Reservar con {{ entrenador?.nombre }} {{ entrenador?.apellidoPaterno }}</h2>
        <p class="subtitulo-modal">{{ entrenador?.deportes?.join(', ') || 'Entrenador' }}</p>
      </div>
      <button class="btn-close" (click)="cerrar()" title="Volver">
        <nb-icon icon="close-outline"></nb-icon>
      </button>
    </div>

    <!-- Indicador de pasos -->
    <div class="steps-indicator" *ngIf="!reservaConfirmada">
      <div *ngFor="let paso of pasos" class="step-item" [class.active]="pasoActual === paso.numero"
        [class.completed]="paso.completado" (click)="irAPaso(paso.numero)">
        <div class="step-circle">
          <nb-icon *ngIf="!paso.completado" [icon]="paso.icono"></nb-icon>
          <nb-icon *ngIf="paso.completado" icon="checkmark-outline"></nb-icon>
        </div>
        <span class="step-label">{{ paso.titulo }}</span>
      </div>
    </div>

    <!-- Contenedor principal -->
    <div class="wizard-layout">
      
      <!-- Contenedor de pasos -->
      <div class="wizard-content">

      <!-- PASO 1: Fecha y Hora -->
      <div class="paso-container" *ngIf="pasoActual === 1">
        <h3 class="paso-titulo">
          <nb-icon icon="calendar-outline"></nb-icon>
          ¿Cuándo te gustaría entrenar?
        </h3>

        <!-- Selector de tipo de reserva -->
        <div class="tipo-reserva-selector">
          <button class="tipo-btn" [class.active]="tipoReserva === 'unica'" (click)="cambiarTipoReserva('unica')">
            <nb-icon icon="calendar-outline"></nb-icon>
            <span>Sesión única</span>
          </button>
          <button class="tipo-btn" [class.active]="tipoReserva === 'multiple'" (click)="cambiarTipoReserva('multiple')">
            <nb-icon icon="layers-outline"></nb-icon>
            <span>Múltiples sesiones</span>
          </button>
        </div>

        <!-- ========== SESIÓN ÚNICA (con calendario visual) ========== -->
        <form [formGroup]="paso1Form" class="paso-form" *ngIf="tipoReserva === 'unica'">
          <div class="form-group">
            <label>Fecha de la sesión *</label>
            
            <!-- Calendario visual premium para sesión única -->
            <div class="calendario-container calendario-premium calendario-profesional">
              <div class="calendario-header">
                <button type="button" class="btn-nav-mes" (click)="cambiarMesUnica(-1)">
                  <nb-icon icon="arrow-ios-back-outline"></nb-icon>
                </button>
                <div class="mes-info">
                  <span class="mes-actual">{{ getNombreMesUnica() }}</span>
                </div>
                <button type="button" class="btn-nav-mes" (click)="cambiarMesUnica(1)">
                  <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                </button>
              </div>
              
              <div class="calendario-dias-semana">
                <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
              </div>
              
              <div class="calendario-grid">
                <div class="calendario-semana" *ngFor="let semana of calendarioUnica">
                  <div *ngFor="let dia of semana" 
                       class="calendario-dia"
                       [class.otro-mes]="!dia.esMesActual"
                       [class.no-disponible]="!dia.disponible && dia.esMesActual"
                       [class.disponible]="dia.disponible && dia.esMesActual"
                       [class.seleccionado]="dia.seleccionado"
                       [class.hoy]="dia.esHoy"
                       (click)="seleccionarDiaUnico(dia)"
                       [attr.data-tooltip]="!dia.disponible && dia.esMesActual ? 'No disponible' : null">
                    <span class="dia-numero">{{ dia.dia }}</span>
                    <span class="dia-estado" *ngIf="dia.disponible && dia.esMesActual && !dia.seleccionado">
                      <span class="estado-dot"></span>
                    </span>
                    <span class="dia-check" *ngIf="dia.seleccionado">
                      <nb-icon icon="checkmark-outline"></nb-icon>
                    </span>
                  </div>
                </div>
              </div>

              <div class="calendario-footer">
                <div class="leyenda-profesional">
                  <span class="leyenda-item">
                    <span class="indicador disponible"></span>
                    Disponible
                  </span>
                  <span class="leyenda-item">
                    <span class="indicador no-disponible"></span>
                    No disponible
                  </span>
                  <span class="leyenda-item">
                    <span class="indicador seleccionado"></span>
                    Seleccionado
                  </span>
                </div>
              </div>
            </div>

            <!-- Fecha seleccionada (hidden para el form) -->
            <input type="hidden" formControlName="fecha" />
            <div class="fecha-seleccionada-info" *ngIf="paso1Form.get('fecha')?.value">
              <nb-icon icon="checkmark-circle-outline"></nb-icon>
              <span>{{ paso1Form.get('fecha')?.value | date:'EEEE d \'de\' MMMM, yyyy':'':'es' }}</span>
            </div>
          </div>

          <!-- Selector de Horarios - Hora Inicio y Hora Fin -->
          <div class="form-group horario-profesional" *ngIf="paso1Form.get('fecha')?.value">
            <div class="horario-header">
              <div class="horario-titulo">
                <nb-icon icon="clock-outline"></nb-icon>
                <span>Horario de la sesión</span>
              </div>
              <span class="horario-badge">Requerido</span>
            </div>
            
            <div *ngIf="cargandoHorarios" class="loading-horarios">
              <nb-spinner status="primary" size="small"></nb-spinner>
              <span>Cargando disponibilidad...</span>
            </div>
            
            <!-- Mensaje cuando el entrenador no tiene disponibilidad para ese día -->
            <div *ngIf="!cargandoHorarios && rangosDelDia.length === 0" class="no-horarios-msg warning">
              <nb-icon icon="alert-circle-outline"></nb-icon>
              <span>El entrenador no tiene disponibilidad para este día. Por favor selecciona otra fecha.</span>
            </div>
            
            <!-- Selectores de hora inicio y fin -->
            <div class="horario-rango-profesional" *ngIf="!cargandoHorarios && rangosDelDia.length > 0">
              <div class="tiempo-selector">
                <div class="tiempo-icono inicio">
                  <span class="icono-texto">IN</span>
                  <span class="icono-punto"></span>
                </div>
                <div class="tiempo-campo">
                  <label class="tiempo-label">Hora de inicio</label>
                  <select formControlName="horaInicio" class="tiempo-select">
                    <option value="">Selecciona hora</option>
                    <option *ngFor="let hora of horasInicio" [value]="hora">{{ hora }}</option>
                  </select>
                </div>
              </div>
              
              <div class="tiempo-conexion">
                <div class="linea-tiempo"></div>
                <div class="duracion-pill" *ngIf="getDuracionSesion() > 0">
                  <nb-icon icon="time-outline"></nb-icon>
                  {{ getDuracionFormateada() }}
                </div>
                <div class="linea-tiempo"></div>
              </div>
              
              <div class="tiempo-selector">
                <div class="tiempo-icono fin">
                  <span class="icono-texto">FIN</span>
                  <span class="icono-punto"></span>
                </div>
                <div class="tiempo-campo">
                  <label class="tiempo-label">Hora de fin</label>
                  <select formControlName="horaFin" class="tiempo-select" 
                          [disabled]="!paso1Form.get('horaInicio')?.value">
                    <option value="">Selecciona hora</option>
                    <option *ngFor="let hora of horasFin" [value]="hora">{{ hora }}</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Mostrar rangos disponibles del entrenador -->
            <div class="rangos-disponibles-pro" *ngIf="!cargandoHorarios && rangosDelDia.length > 0">
              <div class="rangos-header">
                <nb-icon icon="calendar-outline"></nb-icon>
                <span>Horarios disponibles del entrenador</span>
              </div>
              <div class="rangos-grid">
                <div *ngFor="let rango of rangosDelDia" class="rango-card">
                  <span class="rango-tiempo">{{ rango.inicio }} - {{ rango.fin }}</span>
                  <span class="rango-capacidad" *ngIf="rango.capacidad > 1">
                    <nb-icon icon="people-outline"></nb-icon>
                    máx {{ rango.capacidad }}
                  </span>
                </div>
              </div>
            </div>
          </div>

            <small class="error-text" *ngIf="paso1Form.get('horaInicio')?.invalid && paso1Form.get('horaInicio')?.touched">
              Selecciona una hora de inicio
            </small>
            <small class="error-text" *ngIf="paso1Form.get('horaFin')?.invalid && paso1Form.get('horaFin')?.touched">
              Selecciona una hora de fin
            </small>

          <!-- Mensaje cuando no hay fecha seleccionada -->
          <div class="form-group" *ngIf="!paso1Form.get('fecha')?.value">
            <div class="no-horarios-msg">
              <nb-icon icon="calendar-outline"></nb-icon>
              <span>Selecciona una fecha para ver los horarios disponibles</span>
            </div>
          </div>

          <div class="form-group personas-selector">
            <div class="personas-header">
              <label>
                <nb-icon icon="people-outline"></nb-icon>
                Nº Personas
              </label>
              <span class="personas-badge">Requerido</span>
            </div>
            
            <div class="personas-control">
              <button type="button" class="personas-btn menos" 
                      [disabled]="paso1Form.get('cantidadPersonas')?.value <= 1"
                      (click)="decrementarPersonas()">
                <nb-icon icon="minus-outline"></nb-icon>
              </button>
              <div class="personas-display">
                <span class="personas-numero">{{ paso1Form.get('cantidadPersonas')?.value || 1 }}</span>
              </div>
              <button type="button" class="personas-btn mas" 
                      [disabled]="paso1Form.get('cantidadPersonas')?.value >= capacidadMaxima"
                      (click)="incrementarPersonas()">
                <nb-icon icon="plus-outline"></nb-icon>
              </button>
            </div>
            
            <div class="personas-visual">
              <div class="personas-icons">
                <span class="persona-icon" *ngFor="let i of getPersonasArray()" 
                      [class.activo]="i < (paso1Form.get('cantidadPersonas')?.value || 1)">
                  <nb-icon icon="person"></nb-icon>
                </span>
              </div>
              <span class="personas-label">{{ paso1Form.get('cantidadPersonas')?.value || 1 }} de {{ capacidadMaxima }} disponibles</span>
            </div>
            
            <small class="error-text" *ngIf="paso1Form.get('cantidadPersonas')?.hasError('excedeCupos')">
              ¡Capacidad máxima del entrenador: {{ capacidadMaxima }} personas!
            </small>
          </div>

          <!-- Info de tipo de sesión permitida -->
          <div class="form-group tipo-sesion-info" *ngIf="paso1Form.get('horaInicio')?.value && tipoSesionPermitida !== 'ambos'">
            <div class="tipo-badge" [class.individual]="tipoSesionPermitida === 'individual'" 
                 [class.grupal]="tipoSesionPermitida === 'grupal'">
              <nb-icon [icon]="tipoSesionPermitida === 'individual' ? 'person-outline' : 'people-outline'"></nb-icon>
              <span>Este horario es para sesiones {{ tipoSesionPermitida === 'individual' ? 'individuales' : 'grupales' }}</span>
            </div>
          </div>

          <div class="info-box" *ngIf="paso1Form.valid">
            <nb-icon icon="info-outline"></nb-icon>
            <div>
              <strong>Total:</strong> ${{ calcularPrecioTotal() }} MXN
              <br>
              <small>
                ${{ entrenador?.precio || 0 }} x {{ getDuracionFormateada() }} x {{
                paso1Form.get('cantidadPersonas')?.value }} persona(s)
              </small>
            </div>
          </div>
        </form>

        <!-- ========== MÚLTIPLES SESIONES (Unificado) ========== -->
        <div class="multiples-sesiones" *ngIf="tipoReserva === 'multiple'">
          
          <!-- Sub-selector: Modo de selección -->
          <div class="modo-seleccion">
            <button class="modo-btn" [class.active]="modoMultiple === 'calendario'" (click)="cambiarModoMultiple('calendario')">
              <nb-icon icon="calendar-outline"></nb-icon>
              Elegir fechas
            </button>
            <button class="modo-btn" [class.active]="modoMultiple === 'plan'" (click)="cambiarModoMultiple('plan')">
              <nb-icon icon="sync-outline"></nb-icon>
              Plan semanal
            </button>
          </div>

          <!-- ===== MODO CALENDARIO: Seleccionar fechas específicas ===== -->
          <div class="modo-calendario-content" *ngIf="modoMultiple === 'calendario'">
            <div class="instrucciones-multiple">
              <nb-icon icon="bulb-outline"></nb-icon>
              <span>Haz clic en un día disponible para agregar una sesión con su horario</span>
            </div>

            <!-- Calendario visual mejorado (igual que sesión única) -->
            <div class="calendario-container calendario-premium calendario-profesional">
              <div class="calendario-header">
                <button class="btn-nav-mes" (click)="cambiarMes(-1)">
                  <nb-icon icon="arrow-ios-back-outline"></nb-icon>
                </button>
                <div class="mes-info">
                  <span class="mes-actual">{{ getNombreMes() }}</span>
                </div>
                <button class="btn-nav-mes" (click)="cambiarMes(1)">
                  <nb-icon icon="arrow-ios-forward-outline"></nb-icon>
                </button>
              </div>
              
              <div class="calendario-dias-semana">
                <span>Dom</span><span>Lun</span><span>Mar</span><span>Mié</span><span>Jue</span><span>Vie</span><span>Sáb</span>
              </div>
              
              <div class="calendario-grid">
                <div class="calendario-semana" *ngFor="let semana of calendarioMes">
                  <div *ngFor="let dia of semana" 
                       class="calendario-dia"
                       [class.otro-mes]="!dia.esMesActual"
                       [class.no-disponible]="!dia.disponible"
                       [class.disponible]="dia.disponible && dia.esMesActual"
                       [class.seleccionado]="dia.seleccionado"
                       [class.hoy]="dia.esHoy"
                       (click)="abrirSelectorHorario(dia)"
                       [title]="!dia.disponible ? 'El entrenador no trabaja este día' : 'Clic para agregar sesión'">
                    <span class="dia-numero">{{ dia.dia }}</span>
                    <span class="dia-estado" *ngIf="dia.disponible && dia.esMesActual && !dia.seleccionado">
                      <span class="estado-dot"></span>
                    </span>
                    <span class="dia-check" *ngIf="dia.seleccionado">
                      <nb-icon icon="checkmark-outline"></nb-icon>
                    </span>
                  </div>
                </div>
              </div>

              <div class="calendario-footer">
                <div class="leyenda-profesional">
                  <span class="leyenda-item"><span class="indicador disponible"></span> Disponible</span>
                  <span class="leyenda-item"><span class="indicador no-disponible"></span> No trabaja</span>
                  <span class="leyenda-item"><span class="indicador seleccionado"></span> Seleccionado</span>
                </div>
              </div>
            </div>

            <!-- Modal para seleccionar horario del día (Profesional) -->
            <div class="horario-modal-overlay" *ngIf="diaSeleccionandoHorario" (click)="cerrarSelectorHorario()">
              <div class="horario-modal horario-modal-pro" (click)="$event.stopPropagation()">
                <div class="horario-modal-header-pro">
                  <div class="modal-fecha-badge">
                    <nb-icon icon="calendar-outline"></nb-icon>
                    <span>{{ diaSeleccionandoHorario?.fecha | date:'EEEE':'':'es' }}</span>
                  </div>
                  <h4 class="modal-fecha-titulo">
                    {{ diaSeleccionandoHorario?.fecha | date:'d \' de \' MMMM, yyyy':'':'es' }}
                  </h4>
                  <button class="btn-cerrar-modal-pro" (click)="cerrarSelectorHorario()">
                    <nb-icon icon="close-outline"></nb-icon>
                  </button>
                </div>
                
                <div class="horario-modal-body-pro">
                  <div class="selector-titulo">
                    <nb-icon icon="clock-outline"></nb-icon>
                    <span>Selecciona el horario</span>
                  </div>
                  
                  <div class="horario-rango-profesional modal-version">
                    <div class="tiempo-selector">
                      <div class="tiempo-icono inicio">
                        <span class="icono-texto">IN</span>
                        <span class="icono-punto"></span>
                      </div>
                      <div class="tiempo-campo">
                        <label class="tiempo-label">Hora de inicio</label>
                        <select [(ngModel)]="horarioTemporal.horaInicio" class="tiempo-select"
                                (ngModelChange)="onHoraInicioTemporalChange()">
                          <option value="">Selecciona hora</option>
                          <option *ngFor="let h of horasDisponiblesDia" [value]="h">{{ h }}</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="tiempo-conexion">
                      <div class="linea-tiempo"></div>
                      <div class="duracion-pill" *ngIf="getDuracionTemporalFormateada()">
                        <nb-icon icon="time-outline"></nb-icon>
                        {{ getDuracionTemporalFormateada() }}
                      </div>
                      <div class="linea-tiempo"></div>
                    </div>
                    
                    <div class="tiempo-selector">
                      <div class="tiempo-icono fin">
                        <span class="icono-texto">FIN</span>
                        <span class="icono-punto"></span>
                      </div>
                      <div class="tiempo-campo">
                        <label class="tiempo-label">Hora de fin</label>
                        <select [(ngModel)]="horarioTemporal.horaFin" class="tiempo-select">
                          <option value="">Selecciona hora</option>
                          <option *ngFor="let h of horasFinDisponiblesDia" [value]="h">{{ h }}</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Siempre mostrar esta sección para mantener tamaño constante -->
                  <div class="rangos-disponibles-pro modal-version">
                    <div class="rangos-header">
                      <nb-icon icon="flash-outline"></nb-icon>
                      <span>Horarios disponibles</span>
                    </div>
                    <div class="rangos-grid" *ngIf="rangosDisponiblesDia.length > 0">
                      <div class="rango-card" *ngFor="let rango of rangosDisponiblesDia">
                        <span class="rango-tiempo">{{ rango.inicio }} - {{ rango.fin }}</span>
                      </div>
                    </div>
                    <div class="rangos-placeholder" *ngIf="rangosDisponiblesDia.length === 0">
                      <span>Cargando horarios...</span>
                    </div>
                  </div>
                </div>
                
                <div class="horario-modal-footer-pro">
                  <button class="btn-cancelar-pro" (click)="cerrarSelectorHorario()">
                    <nb-icon icon="close-outline"></nb-icon>
                    Cancelar
                  </button>
                  <button class="btn-agregar-pro" 
                          [disabled]="!horarioTemporal.horaInicio || !horarioTemporal.horaFin"
                          (click)="confirmarSesionMultiple()">
                    <nb-icon icon="checkmark-circle-outline"></nb-icon>
                    Agregar sesión
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ===== MODO PLAN: Plan semanal recurrente ===== -->
          <div class="modo-plan-content" *ngIf="modoMultiple === 'plan'">
            <div class="instrucciones-multiple">
              <nb-icon icon="sync-outline"></nb-icon>
              <span>Elige los días de la semana, horario y duración del plan</span>
            </div>

            <!-- Selector de duración -->
            <div class="form-group">
              <label>Duración del plan *</label>
              <div class="duracion-btns">
                <button class="duracion-btn" [class.active]="planRecurrente.duracionMeses === 1" 
                        (click)="setPlanDuracion(1)">
                  1 mes<small>(4 semanas)</small>
                </button>
                <button class="duracion-btn" [class.active]="planRecurrente.duracionMeses === 2" 
                        (click)="setPlanDuracion(2)">
                  2 meses<small>(8 semanas)</small>
                </button>
                <button class="duracion-btn" [class.active]="planRecurrente.duracionMeses === 3" 
                        (click)="setPlanDuracion(3)">
                  3 meses<small>(12 semanas)</small>
                </button>
              </div>
            </div>

            <!-- Selector de días de la semana (múltiple selección) -->
            <div class="form-group">
              <label>Días de la semana * <small class="hint-text">(puedes elegir varios)</small></label>
              <div class="dias-semana-btns">
                <button *ngFor="let dia of diasSemanaOpciones"
                        class="dia-btn" 
                        [class.active]="diasSemanaPlan.includes(dia.key)"
                        [class.no-disponible]="!dia.disponible"
                        [disabled]="!dia.disponible"
                        (click)="toggleDiaSemana(dia.key)">
                  {{ dia.label }}
                  <nb-icon *ngIf="!dia.disponible" icon="close-circle-outline" class="icono-no-disp"></nb-icon>
                </button>
              </div>
              <small class="hint-text" *ngIf="diasSemanaPlan.length > 0">
                {{ diasSemanaPlan.length }} día(s) seleccionado(s) = {{ diasSemanaPlan.length * planRecurrente.duracionMeses * 4 }} sesiones
              </small>
            </div>

            <!-- Horario (Profesional) -->
            <div class="form-group horario-profesional">
              <div class="horario-header">
                <div class="horario-titulo">
                  <nb-icon icon="clock-outline"></nb-icon>
                  <span>Horario semanal</span>
                </div>
                <span class="horario-badge">Requerido</span>
              </div>
              
              <!-- Mensaje si no hay horarios disponibles -->
              <div class="no-horarios-msg warning" *ngIf="horasDisponiblesPlan.length === 0">
                <nb-icon icon="alert-triangle-outline"></nb-icon>
                <span>El entrenador no tiene horarios configurados. Contacta directamente para coordinar.</span>
              </div>
              
              <div class="horario-rango-profesional" *ngIf="horasDisponiblesPlan.length > 0">
                <div class="tiempo-selector">
                  <div class="tiempo-icono inicio">
                    <span class="icono-texto">IN</span>
                    <span class="icono-punto"></span>
                  </div>
                  <div class="tiempo-campo">
                    <label class="tiempo-label">Hora de inicio</label>
                    <select [(ngModel)]="planRecurrente.horaInicio" class="tiempo-select"
                            (change)="calcularFechasRecurrentes()">
                      <option value="">Selecciona hora</option>
                      <option *ngFor="let h of horasDisponiblesPlan" [value]="h">{{ h }}</option>
                    </select>
                  </div>
                </div>
                
                <div class="tiempo-conexion">
                  <div class="linea-tiempo"></div>
                  <div class="duracion-pill" *ngIf="planRecurrente.horaInicio && planRecurrente.horaFin">
                    <nb-icon icon="time-outline"></nb-icon>
                    Plan
                  </div>
                  <div class="linea-tiempo"></div>
                </div>
                
                <div class="tiempo-selector">
                  <div class="tiempo-icono fin">
                    <span class="icono-texto">FIN</span>
                    <span class="icono-punto"></span>
                  </div>
                  <div class="tiempo-campo">
                    <label class="tiempo-label">Hora de fin</label>
                    <select [(ngModel)]="planRecurrente.horaFin" class="tiempo-select"
                            (change)="calcularFechasRecurrentes()">
                      <option value="">Selecciona hora</option>
                      <option *ngFor="let h of horasFinDisponiblesPlan" [value]="h">{{ h }}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mensaje de ayuda para seleccionar horario -->
            <div class="info-box tip" *ngIf="diasSemanaPlan.length > 0 && (!planRecurrente.horaInicio || !planRecurrente.horaFin) && horasDisponiblesPlan.length > 0">
              <nb-icon icon="bulb-outline"></nb-icon>
              <span>Selecciona hora de inicio y fin para ver las fechas de tu plan.</span>
            </div>

            <!-- Vista previa de fechas -->
            <div class="fechas-preview" *ngIf="fechasRecurrentes.length > 0">
              <h4>Tu plan incluye {{ fechasRecurrentes.length }} sesiones:</h4>
              <div class="fechas-grid">
                <span class="fecha-chip" *ngFor="let fecha of fechasRecurrentes">
                  {{ fecha | date:'EEE d MMM':'':'es' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Mensaje si no hay sesiones seleccionadas -->
          <div class="no-horarios-msg" *ngIf="sesionesSeleccionadas.length === 0 && modoMultiple === 'calendario'">
            <nb-icon icon="calendar-outline"></nb-icon>
            <span>Haz clic en los días verdes del calendario para agregar sesiones.</span>
          </div>

          <div class="no-horarios-msg" *ngIf="sesionesSeleccionadas.length === 0 && modoMultiple === 'plan'">
            <nb-icon icon="sync-outline"></nb-icon>
            <span>Selecciona los días de la semana, duración y horario para generar tu plan.</span>
          </div>

          <!-- Lista de sesiones seleccionadas (común) -->
          <div class="sesiones-seleccionadas sesiones-mejorada" *ngIf="sesionesSeleccionadas.length > 0">
            <div class="sesiones-header">
              <h4>
                <nb-icon icon="calendar-outline"></nb-icon>
                Sesiones seleccionadas
              </h4>
              <span class="sesiones-count">{{ sesionesSeleccionadas.length }}</span>
            </div>
            <div class="sesion-chip-mejorado" *ngFor="let sesion of sesionesSeleccionadas; let i = index">
              <div class="sesion-info">
                <span class="sesion-fecha">{{ sesion.fecha | date:'EEEE d':'':'es' }}</span>
                <span class="sesion-mes">{{ sesion.fecha | date:'MMMM':'':'es' }}</span>
              </div>
              <div class="sesion-horario">
                <nb-icon icon="clock-outline"></nb-icon>
                {{ sesion.horaInicio }} - {{ sesion.horaFin }}
              </div>
              <button class="btn-quitar-mejorado" (click)="quitarSesion(i)" title="Quitar sesión">
                <nb-icon icon="trash-2-outline"></nb-icon>
              </button>
            </div>
          </div>

          <!-- Personas (con visual mejorado) -->
          <div class="form-group personas-selector compact">
            <div class="personas-header">
              <label>
                <nb-icon icon="people-outline"></nb-icon>
                Nº Personas por sesión
              </label>
              <span class="personas-badge">Máx. {{ capacidadMaximaMultiple }}</span>
            </div>
            
            <div class="personas-control">
              <button type="button" class="personas-btn menos" 
                      [disabled]="paso1Form.get('cantidadPersonas')?.value <= 1"
                      (click)="decrementarPersonas()">
                <nb-icon icon="minus-outline"></nb-icon>
              </button>
              <div class="personas-display">
                <span class="personas-numero">{{ paso1Form.get('cantidadPersonas')?.value || 1 }}</span>
              </div>
              <button type="button" class="personas-btn mas" 
                      [disabled]="paso1Form.get('cantidadPersonas')?.value >= capacidadMaximaMultiple"
                      (click)="incrementarPersonas()">
                <nb-icon icon="plus-outline"></nb-icon>
              </button>
            </div>
            
            <div class="personas-visual">
              <div class="personas-icons">
                <span class="persona-icon" *ngFor="let i of getPersonasArrayMultiple()" 
                      [class.activo]="i < (paso1Form.get('cantidadPersonas')?.value || 1)">
                  <nb-icon icon="person"></nb-icon>
                </span>
              </div>
            </div>
            
            <small class="error-text" *ngIf="paso1Form.get('cantidadPersonas')?.hasError('excedeCupos')">
              ¡Capacidad máxima: {{ capacidadMaximaMultiple }} personas!
            </small>
          </div>

          <!-- Total -->
          <div class="info-box" *ngIf="sesionesSeleccionadas.length > 0">
            <nb-icon icon="pricetags-outline"></nb-icon>
            <div>
              <strong>Total: ${{ calcularPrecioTotalMultiple() | number:'1.0-0' }} MXN</strong>
              <br>
              <small>{{ sesionesSeleccionadas.length }} sesiones x ${{ entrenador?.precio || 0 }}/hr</small>
            </div>
          </div>
        </div>
      </div>

      <!-- PASO 2: Ubicación y Notas -->
      <div class="paso-container" *ngIf="pasoActual === 2">
        <h3 class="paso-titulo">
          <nb-icon icon="pin-outline"></nb-icon>
          Ubicación del Entrenamiento
        </h3>

        <form [formGroup]="paso2Form" class="paso-form">
          <!-- Dirección del entrenador -->
          <div class="ubicacion-info">
            <div class="ubicacion-card">
              <nb-icon icon="navigate-outline" class="ubicacion-icon"></nb-icon>
              <div class="ubicacion-content">
                <h4>Dirección del entrenamiento</h4>
                <p class="direccion-principal">{{ entrenador?.direccionEntrenamiento || 'No especificada' }}</p>
                <small class="text-muted" *ngIf="entrenador?.ubicacion?.ciudad">
                  {{ entrenador?.ubicacion?.ciudad }}
                </small>
              </div>
            </div>
            <p class="ubicacion-nota">
              <nb-icon icon="info-outline"></nb-icon>
              Esta es la ubicación donde se llevará a cabo la sesión presencial.
            </p>
          </div>

          <div class="form-group">
            <label>Notas adicionales</label>
            <textarea formControlName="notas" placeholder="¿Algo que el entrenador deba saber? (opcional)" class="form-textarea"
              rows="3"></textarea>
          </div>
        </form>
      </div>

      <!-- PASO 3: Datos del Cliente -->
      <div class="paso-container" *ngIf="pasoActual === 3">
        <h3 class="paso-titulo">
          <nb-icon icon="person-outline"></nb-icon>
          Tus datos de contacto
        </h3>

        <div *ngIf="!isLoggedIn" class="no-horarios-msg warning">
          <nb-icon icon="alert-circle-outline"></nb-icon>
          <span>Para continuar con la reserva debes iniciar sesión.</span>
          <button nbButton status="primary" size="small" (click)="irALogin()">
            Iniciar sesión
          </button>
        </div>

        <form *ngIf="isLoggedIn" [formGroup]="paso3Form" class="paso-form">
          <div class="form-group">
            <label>Nombre completo *</label>
            <input type="text" formControlName="nombre" placeholder="Tu nombre" class="form-input" />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" formControlName="email" placeholder="tu@email.com" class="form-input" />
            </div>
            <div class="form-group">
              <label>Teléfono *</label>
              <input type="tel" formControlName="telefono" placeholder="+52 999 123 4567" class="form-input" />
            </div>
          </div>

          <div class="terminos-wrapper">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="aceptaTerminos" />
              <span>Acepto los <a href="/terminos" target="_blank">términos y condiciones</a></span>
            </label>
          </div>
        </form>
      </div>

      <!-- PASO 4: Pago -->
      <div class="paso-container pago" *ngIf="pasoActual === 4 && !mostrarVoucherOxxo">
        <h3 class="paso-titulo">
          <nb-icon icon="credit-card-outline"></nb-icon>
          Método de pago
        </h3>

        <div class="resumen-pago">
          <div class="resumen-precio-grande">
            <span class="label">Total a pagar</span>
            <span class="precio">${{ tipoReserva === 'unica' ? calcularPrecioTotal() : (calcularPrecioTotalMultiple() | number:'1.0-0') }} MXN</span>
          </div>
          <small class="sesiones-info" *ngIf="tipoReserva !== 'unica'">
            {{ getTotalSesiones() }} sesiones programadas
          </small>
        </div>

        <form [formGroup]="paso4Form" class="paso-form">
          <!-- Selector de método de pago -->
          <div class="metodos-pago-grid">
            <label class="metodo-pago-card" [class.selected]="paso4Form.get('metodoPago')?.value === 'tarjeta'">
              <input type="radio" formControlName="metodoPago" value="tarjeta" />
              <div class="metodo-content">
                <nb-icon icon="credit-card-outline"></nb-icon>
                <span class="metodo-titulo">Tarjeta</span>
                <span class="metodo-desc">Crédito o débito</span>
              </div>
            </label>

            <label class="metodo-pago-card" [class.selected]="paso4Form.get('metodoPago')?.value === 'oxxo'">
              <input type="radio" formControlName="metodoPago" value="oxxo" />
              <div class="metodo-content">
                <div class="oxxo-logo">
                  <span class="oxxo-text">OXXO</span>
                </div>
                <span class="metodo-titulo">OXXO</span>
                <span class="metodo-desc">Pago en efectivo</span>
              </div>
            </label>
          </div>

          <!-- Campos para TARJETA -->
          <div class="tarjeta-fields" *ngIf="paso4Form.get('metodoPago')?.value === 'tarjeta'">
            <div class="form-group">
              <label>Número de tarjeta *</label>
              <input type="text" formControlName="numeroTarjeta" placeholder="1234 5678 9012 3456" class="form-input"
                maxlength="19" (input)="formatearTarjeta($event)" />
              <small class="error-text"
                *ngIf="paso4Form.get('numeroTarjeta')?.invalid && paso4Form.get('numeroTarjeta')?.touched">
                Ingresa un número de tarjeta válido (16 dígitos)
              </small>
            </div>

            <div class="form-group">
              <label>Nombre del titular *</label>
              <input type="text" formControlName="nombreTitular" placeholder="Como aparece en la tarjeta"
                class="form-input" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Fecha de expiración *</label>
                <input type="text" formControlName="fechaExpiracion" placeholder="MM/AA" class="form-input" maxlength="5"
                  (input)="formatearFechaExpiracion($event)" />
                <small class="error-text"
                  *ngIf="paso4Form.get('fechaExpiracion')?.invalid && paso4Form.get('fechaExpiracion')?.touched">
                  Formato: MM/AA
                </small>
              </div>
              <div class="form-group">
                <label>CVV *</label>
                <input type="text" formControlName="cvv" placeholder="123" class="form-input" maxlength="4" />
                <small class="error-text" *ngIf="paso4Form.get('cvv')?.invalid && paso4Form.get('cvv')?.touched">
                  Código de seguridad (3-4 dígitos)
                </small>
              </div>
            </div>
          </div>

          <!-- Campos para OXXO -->
          <div class="oxxo-fields" *ngIf="paso4Form.get('metodoPago')?.value === 'oxxo'">
            <div class="oxxo-info-box">
              <nb-icon icon="info-outline"></nb-icon>
              <div>
                <strong>¿Cómo funciona?</strong>
                <ol>
                  <li>Generamos un voucher con tu referencia de pago</li>
                  <li>Ve a cualquier tienda OXXO y proporciona la referencia</li>
                  <li>Paga en efectivo el monto indicado</li>
                  <li>Tu reserva se confirma automáticamente</li>
                </ol>
              </div>
            </div>

            <div class="oxxo-email-info">
              <nb-icon icon="email-outline"></nb-icon>
              <span>El voucher se enviará a: <strong>{{ paso3Form.get('email')?.value }}</strong></span>
            </div>

            <div class="oxxo-nota">
              <nb-icon icon="clock-outline"></nb-icon>
              <span>Tienes <strong>3 días</strong> para realizar el pago en OXXO</span>
            </div>
          </div>

          <div class="terminos-wrapper">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="aceptaPoliticas" />
              <span>Acepto las <a href="/politicas-pago" target="_blank">políticas de pago</a> y <a href="/terminos"
                  target="_blank">términos y condiciones</a></span>
            </label>
          </div>

          <div class="info-seguridad">
            <nb-icon icon="lock-outline"></nb-icon>
            <span>Tu información está protegida con encriptación SSL</span>
          </div>
        </form>

        <!-- Resumen de confirmación antes de pagar -->
        <div class="confirmacion-pago-resumen">
          <h4>
            <nb-icon icon="checkmark-circle-outline"></nb-icon>
            Confirma los datos de tu reserva
          </h4>
          
          <div class="confirmacion-grid">
            <div class="confirmacion-item">
              <span class="conf-label">Entrenador</span>
              <span class="conf-value">{{ entrenador?.nombre }} {{ entrenador?.apellidoPaterno }}</span>
            </div>
            
            <div class="confirmacion-item" *ngIf="tipoReserva === 'unica'">
              <span class="conf-label">Fecha</span>
              <span class="conf-value">{{ paso1Form.get('fecha')?.value | date:'fullDate':'':'es' }}</span>
            </div>
            
            <div class="confirmacion-item" *ngIf="tipoReserva === 'unica'">
              <span class="conf-label">Horario</span>
              <span class="conf-value">{{ paso1Form.get('horaInicio')?.value }} - {{ paso1Form.get('horaFin')?.value }}</span>
            </div>
            
            <div class="confirmacion-item" *ngIf="tipoReserva !== 'unica'">
              <span class="conf-label">Sesiones</span>
              <span class="conf-value">{{ sesionesSeleccionadas.length }} sesiones programadas</span>
            </div>
            
            <div class="confirmacion-item">
              <span class="conf-label">Personas</span>
              <span class="conf-value">{{ paso1Form.get('cantidadPersonas')?.value }}</span>
            </div>
            
            <div class="confirmacion-item">
              <span class="conf-label">Contacto</span>
              <span class="conf-value">{{ paso3Form.get('email')?.value }}</span>
            </div>
          </div>
          
          <div class="confirmacion-total">
            <span>Total a pagar:</span>
            <strong>${{ tipoReserva === 'unica' ? calcularPrecioTotal() : (calcularPrecioTotalMultiple() | number:'1.0-0') }} MXN</strong>
          </div>
        </div>

        <button class="btn-pagar" (click)="procesarPago()" [disabled]="procesandoPago || !paso4Form.valid">
          <nb-spinner *ngIf="procesandoPago" size="small" status="control"></nb-spinner>
          <nb-icon icon="card-outline" *ngIf="!procesandoPago && paso4Form.get('metodoPago')?.value === 'tarjeta'"></nb-icon>
          <span *ngIf="!procesandoPago && paso4Form.get('metodoPago')?.value === 'oxxo'" class="oxxo-btn-text">OXXO</span>
          {{ procesandoPago ? 'Procesando...' : (paso4Form.get('metodoPago')?.value === 'oxxo' ? 'Generar voucher OXXO' : 'Pagar $' + (tipoReserva === 'unica' ? calcularPrecioTotal() : calcularPrecioTotalMultiple()) + ' MXN') }}
        </button>
      </div>

      <!-- PASO 5: Confirmación / Resumen -->
      <div class="paso-container confirmacion" *ngIf="pasoActual === 5 && !reservaConfirmada">
        <h3 class="paso-titulo">
          <nb-icon icon="checkmark-circle-outline"></nb-icon>
          Confirma tu reserva
        </h3>

        <div class="resumen-reserva">
          <div class="resumen-item">
            <nb-icon icon="person-outline"></nb-icon>
            <div>
              <strong>Entrenador</strong>
              <p>{{ entrenador?.nombre }}</p>
            </div>
          </div>

          <!-- Sesión única -->
          <div class="resumen-item" *ngIf="tipoReserva === 'unica'">
            <nb-icon icon="calendar-outline"></nb-icon>
            <div>
              <strong>Fecha y Hora</strong>
              <p>{{ paso1Form.get('fecha')?.value | date:'fullDate':'':'es' }}</p>
              <small>{{ paso1Form.get('horaInicio')?.value }} - {{ paso1Form.get('horaFin')?.value }} ({{ getDuracionFormateada() }})</small>
            </div>
          </div>

          <!-- Múltiples sesiones -->
          <div class="resumen-item sesiones-multiples" *ngIf="tipoReserva !== 'unica'">
            <nb-icon icon="layers-outline"></nb-icon>
            <div>
              <strong>{{ getTotalSesiones() }} Sesiones programadas</strong>
              <div class="resumen-sesiones-lista">
                <span class="sesion-mini" *ngFor="let sesion of sesionesSeleccionadas | slice:0:5">
                  {{ sesion.fecha | date:'EEE d MMM':'':'es' }} · {{ sesion.horaInicio }}-{{ sesion.horaFin }}
                </span>
                <span class="sesion-mini mas" *ngIf="sesionesSeleccionadas.length > 5">
                  +{{ sesionesSeleccionadas.length - 5 }} más...
                </span>
              </div>
            </div>
          </div>

          <div class="resumen-item">
            <nb-icon icon="people-outline"></nb-icon>
            <div>
              <strong>Personas</strong>
              <p>{{ paso1Form.get('cantidadPersonas')?.value }} persona(s)</p>
            </div>
          </div>

          <div class="resumen-item" *ngIf="tipoReserva === 'unica'">
            <nb-icon icon="clock-outline"></nb-icon>
            <div>
              <strong>Duración</strong>
              <p>{{ getDuracionFormateada() }}</p>
            </div>
          </div>

          <div class="resumen-item">
            <nb-icon icon="pin-outline"></nb-icon>
            <div>
              <strong>Ubicación</strong>
              <p>{{ entrenador?.direccionEntrenamiento || 'Por confirmar' }}</p>
              <small class="text-muted">Sesión presencial</small>
            </div>
          </div>

          <div class="resumen-item" *ngIf="pagoCompletado">
            <nb-icon icon="checkmark-circle-outline" style="color: #10B981;"></nb-icon>
            <div>
              <strong>Pago</strong>
              <p style="color: #10B981;">Pagado - ${{ tipoReserva === 'unica' ? calcularPrecioTotal() : calcularPrecioTotalMultiple() | number:'1.0-0' }} MXN</p>
            </div>
          </div>

          <div class="resumen-precio">
            <strong>Total pagado:</strong>
            <span class="precio">${{ tipoReserva === 'unica' ? calcularPrecioTotal() : (calcularPrecioTotalMultiple() | number:'1.0-0') }} MXN</span>
          </div>
        </div>

        <button class="btn-confirmar" (click)="confirmarReserva()" [disabled]="enviando || !pagoCompletado">
          {{ enviando ? 'Confirmando...' : 'Confirmar Reserva' }}
        </button>
      </div>

      <!-- MENSAJE DE ÉXITO -->
      <div class="paso-container exito" *ngIf="reservaConfirmada">
        <div class="icono-exito">
          <nb-icon icon="checkmark-circle-2-outline"></nb-icon>
        </div>

        <h3>¡Reserva Confirmada!</h3>

        <div class="numero-reserva">
          <p>Número de reserva:</p>
          <strong>{{ numeroReserva }}</strong>
        </div>

        <p class="mensaje-exito">
          Hemos enviado un correo de confirmación a <strong>{{ paso3Form.get('email')?.value }}</strong>
        </p>

        <div class="acciones-exito">
          <button class="btn-whatsapp" (click)="contactarWhatsApp()">
            <nb-icon icon="message-circle-outline"></nb-icon>
            Contactar por WhatsApp
          </button>
          <button class="btn-cerrar" (click)="cerrar()">
            Volver al inicio
          </button>
        </div>
      </div>

    </div>

      <!-- Botón flotante para mostrar resumen -->
      <button class="btn-resumen-flotante" 
              *ngIf="pasoActual < 5 && !reservaConfirmada"
              (click)="resumenExpandido = !resumenExpandido"
              [class.activo]="resumenExpandido">
        <nb-icon [icon]="resumenExpandido ? 'close-outline' : 'clipboard-outline'"></nb-icon>
        <span class="btn-resumen-precio">${{ tipoReserva === 'unica' ? calcularPrecioTotal() : (calcularPrecioTotalMultiple() | number:'1.0-0') }}</span>
        <span class="btn-resumen-label">{{ resumenExpandido ? 'Cerrar' : 'Ver resumen' }}</span>
      </button>

      <!-- Panel de Resumen Lateral (Colapsable) -->
      <div class="resumen-overlay" 
           *ngIf="pasoActual < 5 && !reservaConfirmada && resumenExpandido"
           (click)="resumenExpandido = false">
      </div>
      <div class="resumen-lateral colapsable" 
           *ngIf="pasoActual < 5 && !reservaConfirmada"
           [class.expandido]="resumenExpandido">
        <div class="resumen-sticky">
          <div class="resumen-header-colapsable">
            <h4 class="resumen-titulo">
              <nb-icon icon="clipboard-outline"></nb-icon>
              Tu Reserva
            </h4>
            <button class="btn-cerrar-resumen" (click)="resumenExpandido = false">
              <nb-icon icon="close-outline"></nb-icon>
            </button>
          </div>

          <!-- Entrenador -->
          <div class="resumen-item">
            <div class="resumen-avatar" *ngIf="entrenador?.fotoURL">
              <img [src]="entrenador?.fotoURL" [alt]="entrenador?.nombre" />
            </div>
            <div class="resumen-avatar placeholder" *ngIf="!entrenador?.fotoURL">
              <nb-icon icon="person-outline"></nb-icon>
            </div>
            <div class="resumen-info">
              <span class="resumen-label">Entrenador</span>
              <span class="resumen-value">{{ entrenador?.nombre }} {{ entrenador?.apellidoPaterno }}</span>
            </div>
          </div>

          <!-- Tipo de reserva -->
          <div class="resumen-item">
            <nb-icon [icon]="tipoReserva === 'unica' ? 'calendar-outline' : 'layers-outline'"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Tipo</span>
              <span class="resumen-value">{{ tipoReserva === 'unica' ? 'Sesión única' : 'Múltiples sesiones' }}</span>
            </div>
          </div>

          <!-- Fecha(s) seleccionada(s) -->
          <div class="resumen-item" *ngIf="tipoReserva === 'unica' && paso1Form.get('fecha')?.value">
            <nb-icon icon="calendar-outline"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Fecha</span>
              <span class="resumen-value">{{ paso1Form.get('fecha')?.value | date:'EEEE d MMMM':'':'es' }}</span>
            </div>
          </div>

          <!-- Horario sesión única -->
          <div class="resumen-item" *ngIf="tipoReserva === 'unica' && paso1Form.get('horaInicio')?.value">
            <nb-icon icon="clock-outline"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Horario</span>
              <span class="resumen-value">{{ paso1Form.get('horaInicio')?.value }} - {{ paso1Form.get('horaFin')?.value || '...' }}</span>
            </div>
          </div>

          <!-- Sesiones múltiples -->
          <div class="resumen-item sesiones" *ngIf="tipoReserva !== 'unica' && sesionesSeleccionadas.length > 0">
            <nb-icon icon="layers-outline"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Sesiones</span>
              <span class="resumen-value">{{ sesionesSeleccionadas.length }} sesiones</span>
              <div class="mini-sesiones">
                <span class="mini-sesion" *ngFor="let s of sesionesSeleccionadas | slice:0:3">
                  {{ s.fecha | date:'d/M':'':'es' }}
                </span>
                <span class="mini-sesion more" *ngIf="sesionesSeleccionadas.length > 3">
                  +{{ sesionesSeleccionadas.length - 3 }}
                </span>
              </div>
            </div>
          </div>

          <!-- Personas -->
          <div class="resumen-item">
            <nb-icon icon="people-outline"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Personas</span>
              <span class="resumen-value">{{ paso1Form.get('cantidadPersonas')?.value || 1 }}</span>
            </div>
          </div>

          <!-- Ubicación (paso 2) -->
          <div class="resumen-item" *ngIf="pasoActual >= 2">
            <nb-icon icon="pin-outline"></nb-icon>
            <div class="resumen-info">
              <span class="resumen-label">Ubicación</span>
              <span class="resumen-value">{{ entrenador?.direccionEntrenamiento || 'Por confirmar' }}</span>
            </div>
          </div>

          <!-- Separador -->
          <div class="resumen-divider"></div>

          <!-- Total -->
          <div class="resumen-total">
            <span class="total-label">Total</span>
            <span class="total-value">${{ tipoReserva === 'unica' ? calcularPrecioTotal() : (calcularPrecioTotalMultiple() | number:'1.0-0') }} MXN</span>
          </div>

          <!-- Desglose -->
          <div class="resumen-desglose">
            <small *ngIf="tipoReserva === 'unica'">
              ${{ entrenador?.precio || 0 }}/hr × {{ getDuracionFormateada() }} × {{ paso1Form.get('cantidadPersonas')?.value || 1 }} persona(s)
            </small>
            <small *ngIf="tipoReserva !== 'unica'">
              {{ sesionesSeleccionadas.length }} sesiones × ${{ entrenador?.precio || 0 }}/hr
            </small>
          </div>

          <!-- Políticas -->
          <div class="resumen-politicas">
            <nb-icon icon="shield-outline"></nb-icon>
            <div>
              <strong>Política de cancelación</strong>
              <p>Cancelación gratuita hasta 24 horas antes. Después se cobra el 50%.</p>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- Cierre wizard-layout -->

      <!-- Botones de navegación -->
      <div class="navigation-buttons" *ngIf="pasoActual < 5 && !reservaConfirmada && pasoActual !== 4">
        <button class="btn-anterior" (click)="anterior()" [disabled]="pasoActual === 1">
          <nb-icon icon="arrow-back-outline"></nb-icon>
          Anterior
        </button>

        <div class="btn-siguiente-wrapper">
          <button class="btn-siguiente" (click)="siguiente()" [disabled]="!validarPasoActual()">
            Siguiente
            <nb-icon icon="arrow-forward-outline"></nb-icon>
          </button>
          <span class="mensaje-faltante" *ngIf="!validarPasoActual() && getMensajeFaltante()">
            <nb-icon icon="alert-circle-outline"></nb-icon>
            {{ getMensajeFaltante() }}
          </span>
        </div>
      </div>
    </div>
  </div>
  </nb-layout-column>
</nb-layout>