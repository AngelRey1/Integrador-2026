<div class="container-fluid disponibilidad-container">
  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <nb-spinner size="large" status="primary"></nb-spinner>
    <p>Cargando disponibilidad...</p>
  </div>

  <div *ngIf="!loading">
    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <h3 class="page-title">
              <nb-icon icon="calendar-outline"></nb-icon>
              Mi Disponibilidad Semanal
            </h3>
            <p class="text-hint mb-0">Configura los días y horarios en los que estás disponible para sesiones</p>
          </div>
          <button nbButton status="primary" 
                  [disabled]="guardando"
                  (click)="guardarDisponibilidad()">
            <nb-icon icon="save-outline"></nb-icon>
            {{ guardando ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Grid de días -->
    <div class="dias-grid">
      <nb-card *ngFor="let dia of diasSemana" 
               class="dia-card"
               [class.dia-habilitado]="dia.habilitado"
               [class.dia-deshabilitado]="!dia.habilitado">
        
        <!-- Header del día -->
        <nb-card-header class="dia-header">
          <div class="dia-info">
            <span class="dia-nombre">{{ dia.nombre }}</span>
          </div>
          <nb-toggle [checked]="dia.habilitado" 
                     (checkedChange)="toggleDia(dia)"
                     status="success">
          </nb-toggle>
        </nb-card-header>

        <!-- Body con rangos de horario -->
        <nb-card-body>
          <div *ngIf="dia.habilitado; else diaDeshabilitado">
            <!-- Lista de rangos -->
            <div class="rangos-container">
              <div *ngFor="let rango of dia.rangos; let i = index" class="rango-item">
                <!-- Horarios -->
                <div class="rango-inputs">
                  <div class="hora-grupo">
                    <label class="hora-label">Desde</label>
                    <nb-select [(selected)]="rango.inicio" size="small" class="hora-select">
                      <nb-option *ngFor="let hora of horasDisponibles" [value]="hora">
                        {{ hora }}
                      </nb-option>
                    </nb-select>
                  </div>
                  <span class="rango-separador">–</span>
                  <div class="hora-grupo">
                    <label class="hora-label">Hasta</label>
                    <nb-select [(selected)]="rango.fin" size="small" class="hora-select">
                      <nb-option *ngFor="let hora of getHorasFinDisponibles(rango)" [value]="hora">
                        {{ hora }}
                      </nb-option>
                    </nb-select>
                  </div>
                  <button nbButton ghost status="danger" size="small" 
                          class="btn-eliminar"
                          (click)="eliminarRango(dia, i)"
                          nbTooltip="Eliminar este horario">
                    <nb-icon icon="trash-2-outline"></nb-icon>
                  </button>
                </div>

                <!-- Configuración de capacidad y tipo -->
                <div class="rango-config">
                  <div class="config-grupo">
                    <label class="config-label">
                      <nb-icon icon="people-outline"></nb-icon>
                      Capacidad máx.
                    </label>
                    <nb-select [(selected)]="rango.capacidad" size="small" class="capacidad-select">
                      <nb-option *ngFor="let cap of opcionesCapacidad" [value]="cap">
                        {{ cap }} {{ cap === 1 ? 'persona' : 'personas' }}
                      </nb-option>
                    </nb-select>
                  </div>
                  <div class="config-grupo">
                    <label class="config-label">
                      <nb-icon [icon]="getTipoSesionIcon(rango.tipoSesion)"></nb-icon>
                      Tipo sesión
                    </label>
                    <nb-select [(selected)]="rango.tipoSesion" size="small" class="tipo-select">
                      <nb-option *ngFor="let tipo of tiposSesion" [value]="tipo.value">
                        {{ tipo.label }}
                      </nb-option>
                    </nb-select>
                  </div>
                </div>
                
                <!-- Indicador de error si el rango es inválido -->
                <small *ngIf="!validarRango(rango)" class="text-danger">
                  La hora de fin debe ser mayor que la de inicio
                </small>
              </div>
            </div>

            <!-- Botón agregar rango -->
            <button nbButton ghost status="primary" size="small" 
                    class="btn-agregar-rango"
                    (click)="agregarRango(dia)">
              <nb-icon icon="plus-outline"></nb-icon>
              Agregar otro horario
            </button>
          </div>

          <ng-template #diaDeshabilitado>
            <div class="dia-no-disponible">
              <nb-icon icon="moon-outline"></nb-icon>
              <span>No disponible</span>
              <small>Activa el día para configurar horarios</small>
            </div>
          </ng-template>
        </nb-card-body>
      </nb-card>
    </div>

    <!-- Resumen -->
    <nb-card class="resumen-card mt-4">
      <nb-card-header>
        <nb-icon icon="clock-outline"></nb-icon>
        Resumen de tu disponibilidad
      </nb-card-header>
      <nb-card-body>
        <div class="resumen-grid">
          <div *ngFor="let dia of diasSemana" 
               class="resumen-item"
               [class.disponible]="dia.habilitado">
            <span class="resumen-dia">{{ dia.nombre }}</span>
            <span class="resumen-horarios" [class.no-disponible]="!dia.habilitado">
              {{ getResumenDia(dia) }}
            </span>
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <!-- Nota informativa -->
    <nb-alert status="info" closable="false" class="mt-3">
      <nb-icon icon="info-outline"></nb-icon>
      <strong>Nota:</strong> Esta es tu disponibilidad base semanal. Los clientes podrán reservar sesiones 
      dentro de estos horarios. Para bloquear fechas específicas, usa la sección de "Gestión de Clases".
    </nb-alert>
  </div>
</div>
